---
title: "Parsing MoNA JSON"
author: "Michael Witting"
date: "19 11 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r load required libraries}
library(jsonlite)
library(metabolomicsUtils)
library(tidyverse)
```

Here we use <code>read_json</code> from the <code>jsonlite</code> package to parse the JSON file. The function returns a list in which each entry represents on mass spectrum.

```{r load json data}
json_file <- system.file("extdata/MoNA-export-MetaboBASE.json", package = "metabolomicsUtils")
metabobase_list <- read_json(json_file)
```

```{r}
metabobase_tibble <- tibble(
  id = unlist(lapply(metabobase_list, mona_isolate_id)),
  name = unlist(lapply(metabobase_list, mona_isolate_name)),
  formula = unlist(lapply(metabobase_list, mona_isolate_formula)),
  exactMass = unlist(lapply(metabobase_list, mona_isolate_exact_mass)),
  smiles = unlist(lapply(metabobase_list, mona_isolate_smiles)),
  inchi = unlist(lapply(metabobase_list, mona_isolate_inchi)),
  instrument = "prediction",
  instrumentType = "predictions",
  msType = "MS2",
  precursorMz = unlist(lapply(metabobase_list, mona_isolate_precursorMz)),
  adductType = unlist(lapply(metabobase_list, mona_isolate_adduct)),
  splash = unlist(lapply(metabobase_list, mona_isolate_splash)),
  spectrum = unlist(lapply(metabobase_list, mona_isolate_spectrum))) %>%
  mutate(ionMode = if_else(
    adductType %in% c("[M-H]-", "[M+Hac-H]-", "[M+FA-H]-"),
    "NEGATIVE",
    "POSITIVE")) %>%
  mutate(adductType = if_else(adductType == "[M+Hac-H]-", "[M+HAc-H]-", adductType))
```

```{r}
metabobase_tibble_filted <- metabobase_tibble %>% 
  drop_na()
```

```{r}
# create Spectrum2 objects from tibble =========================================
# create empty Spectra object
lipidBlast_Neg_Spectra <- Spectra()
lipidBlast_Pos_Spectra <- Spectra()

# iterate over tibble and create spectrum
for(i in 1:nrow(lipidBlast_tibble)) {

    # get spectrum
    spectrum <- as_tibble(t(read.table(textConnection(lipidBlast_tibble$spectrum[i]))),
                          .name_repair = "universal") %>%
      separate(...1, sep = ":",
               into = c("mz", "int"),
               convert = TRUE)
    
    # create MS2 spectrum
    ms2Spec <- new(
      "Spectrum2",
      merged = 0,
      precScanNum = as.integer(1),
      precursorMz = lipidBlast_tibble$precursorMz[i],
      precursorIntensity = 100,
      precursorCharge = as.integer(1),
      mz = spectrum$mz,
      intensity = spectrum$int,
      collisionEnergy = 40,
      centroided = TRUE
    )
    
    # create spectra object for return
    lipidSpectrum <- Spectra(ms2Spec)
    
    # fill basic metadata
    mcols(lipidSpectrum)$id <- lipidBlast_tibble$id[i]
    mcols(lipidSpectrum)$name <- lipidBlast_tibble$name[i]
    mcols(lipidSpectrum)$formula <- lipidBlast_tibble$formula[i]
    mcols(lipidSpectrum)$exactMass <- lipidBlast_tibble$exactMass[i]
    mcols(lipidSpectrum)$smiles <- lipidBlast_tibble$smiles[i]
    mcols(lipidSpectrum)$inchi <- lipidBlast_tibble$inchi[i]
    mcols(lipidSpectrum)$instrument <- lipidBlast_tibble$instrument[i]
    mcols(lipidSpectrum)$instrumentType <- lipidBlast_tibble$instrumentType[i]
    mcols(lipidSpectrum)$msType <- lipidBlast_tibble$msType[i]
    mcols(lipidSpectrum)$ionMode <- lipidBlast_tibble$ionMode[i]
    mcols(lipidSpectrum)$precursorMz <- lipidBlast_tibble$precursorMz[i]
    mcols(lipidSpectrum)$precursorType <- lipidBlast_tibble$adductType[i]
    mcols(lipidSpectrum)$splash <- lipidBlast_tibble$splash[i]
    mcols(lipidSpectrum)$numPeak <- peaksCount(ms2Spec)
    
    # add to list
    if(lipidBlast_tibble$ionMode[i] == "NEGATIVE") {
      lipidBlast_Neg_Spectra <- append(lipidBlast_Neg_Spectra, lipidSpectrum)
    } else if(lipidBlast_tibble$ionMode[i] == "POSITIVE") {
      lipidBlast_Pos_Spectra <- append(lipidBlast_Pos_Spectra, lipidSpectrum)
    } else {
      print("unknown polarity")
    }
  
}

# make library for masstrixR ===================================================
# create MS2 SQLite DB with masstrixR
createMs2Db(lipidBlast_Pos_Spectra, "E:\\LipidBlast_pos_MS2")
createMs2Db(lipidBlast_Neg_Spectra, "E:\\LipidBlast_neg_MS2")
```

